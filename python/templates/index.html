<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Git Mirror Runner Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>Git Mirror Runner Dashboard</h1>
    
    <!-- Enqueue New Repository -->
    <section id="enqueue">
      <h2>Add Repository</h2>
      <form id="enqueueForm">
        <label for="git_uri">Git Repository (HTTPS):</label>
        <input type="text" id="git_uri" name="git_uri" placeholder="https://github.com/username/repository.git" required>
        <button type="submit">Enqueue Repository</button>
      </form>
    </section>
    
    <!-- Current Running Task -->
    <section id="currentTask">
      <h2>Current Running Task</h2>
      <div id="currentTaskInfo">
        <p>No task is currently running.</p>
      </div>
      <button id="killTaskBtn" style="display:none;">Kill Running Task</button>
    </section>
    
    <!-- Pending Tasks Queue -->
    <section id="queue">
      <h2>Pending Tasks Queue</h2>
      <table id="queueTable">
        <thead>
          <tr>
            <th>Task ID</th>
            <th>Repository</th>
            <th>Created At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </section>
    
    <!-- Finished/Failed Tasks -->
    <section id="finished">
      <h2>Finished / Failed Tasks</h2>
      <table id="finishedTable">
        <thead>
          <tr>
            <th>Task ID</th>
            <th>Repository</th>
            <th>Status</th>
            <th>Started At</th>
            <th>Finished At</th>
            <th>Logs</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </section>
    
    <!-- Logs Viewer -->
    <section id="logsViewer">
      <h2>Logs Viewer</h2>
      <select id="logTaskSelect">
        <option value="">Select a task</option>
      </select>
      <div id="logs"></div>
    </section>
  </div>
  
  <script src="/static/jquery.min.js"></script>
  <script>
    $(document).ready(function() {
      function refreshTasks() {
        $.getJSON('/tasks', function(data) {
          var currentTask = null, queueTasks = [], finishedTasks = [];
          var logSelectOptions = '<option value="">Select a task</option>';
          $.each(data, function(i, task) {
            if(task.status === "running") {
              currentTask = task;
            } else if(task.status === "queued") {
              queueTasks.push(task);
            } else if(task.status === "finished" || task.status === "failed" || task.status === "canceled") {
              finishedTasks.push(task);
            }
            logSelectOptions += '<option value="'+ task.id +'">'+ task.git_uri +' ('+ task.status +')</option>';
          });
          // Update current task display.
          if(currentTask) {
            $('#currentTaskInfo').html(
              '<p><strong>ID:</strong> ' + currentTask.id + '<br>' +
              '<strong>Repo:</strong> ' + currentTask.git_uri + '<br>' +
              '<strong>Started:</strong> ' + currentTask.started_at + '</p>'
            );
            $('#killTaskBtn').show();
          } else {
            $('#currentTaskInfo').html('<p>No task is currently running.</p>');
            $('#killTaskBtn').hide();
          }
          // Update queue table.
          var queueHtml = '';
          $.each(queueTasks, function(i, task) {
            queueHtml += '<tr>' +
                         '<td>' + task.id + '</td>' +
                         '<td>' + task.git_uri + '</td>' +
                         '<td>' + task.created_at + '</td>' +
                         '<td><button class="removeTask" data-taskid="'+task.id+'">Remove</button></td>' +
                         '</tr>';
          });
          $('#queueTable tbody').html(queueHtml);
          
          // Update finished table.
          var finishedHtml = '';
          $.each(finishedTasks, function(i, task) {
            finishedHtml += '<tr>' +
                            '<td>' + task.id + '</td>' +
                            '<td>' + task.git_uri + '</td>' +
                            '<td>' + task.status + '</td>' +
                            '<td>' + (task.started_at || '-') + '</td>' +
                            '<td>' + (task.finished_at || '-') + '</td>' +
                            '<td><a href="/logs/'+ task.id +'" target="_blank">View</a></td>' +
                            '</tr>';
          });
          $('#finishedTable tbody').html(finishedHtml);
          
          $('#logTaskSelect').html(logSelectOptions);
        });
      }
      
      refreshTasks();
      setInterval(refreshTasks, 5000);
      
      // Enqueue repository.
      $('#enqueueForm').submit(function(e) {
        e.preventDefault();
        $.post('/enqueue', $(this).serialize(), function(response) {
          alert(response.message);
          refreshTasks();
        }).fail(function(xhr) {
          alert(xhr.responseJSON.error);
        });
      });
      
      // Remove a queued task.
      $(document).on('click', '.removeTask', function() {
        var taskId = $(this).data('taskid');
        $.post('/remove', { task_id: taskId }, function(response) {
          alert(response.message);
          refreshTasks();
        }).fail(function(xhr) {
          alert(xhr.responseJSON.error);
        });
      });
      
      // Kill the current task.
      $('#killTaskBtn').click(function() {
        if(confirm("Are you sure you want to kill the running task?")) {
          $.post('/kill', function(response) {
            alert(response.message);
            refreshTasks();
          }).fail(function(xhr) {
            alert(xhr.responseJSON.error);
          });
        }
      });
      
      // Stream logs for the selected task.
      $('#logTaskSelect').change(function() {
        var taskId = $(this).val();
        if(window.logEventSource) {
          window.logEventSource.close();
        }
        if(!taskId) {
          $('#logs').html('');
          return;
        }
        window.logEventSource = new EventSource('/stream_logs/' + taskId);
        window.logEventSource.onmessage = function(event) {
          $('#logs').append(event.data + '<br>');
          $('#logs').scrollTop($('#logs')[0].scrollHeight);
        };
        window.logEventSource.onerror = function(error) {
          console.error("Error in log stream", error);
          window.logEventSource.close();
        };
      });
    });
  </script>
</body>
</html>
